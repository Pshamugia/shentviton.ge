function B(e,n,r=null){e.preventDefault(),r===null&&(r=n.classList.contains("open")?0:1),n.classList.toggle("open",r>0),n.classList.toggle("close",r<=0)}const O=e=>{if(!e)throw new Error("Canvas is required to initialize defaults.");return{text:{fontSize:30,fill:"#000000",fontFamily:"Arial",hasControls:!0,editable:!0,stay:!0},მაისური:{box:{strokeDashArray:[5,5],fill:"transparent",selectable:!1,evented:!1,stay:!0,stay_when_pos:!0,left:e.width/2,top:e.height/2,width:e.width*.4,height:e.height*.3,originX:"center",originY:"center"}},ქეისი:{box:{strokeDashArray:[5,5],fill:"transparent",selectable:!1,evented:!1,stay:!0,stay_when_pos:!0,left:e.width/2,top:e.height/2+50,width:e.width*.3,height:e.height*.3,originX:"center",originY:"center"}},კეპი:{box:{strokeDashArray:[5,5],fill:"transparent",selectable:!1,evented:!1,stay:!0,stay_when_pos:!0,left:e.width/2,top:e.height/2,width:e.width*.4,height:e.height*.2,originX:"center",originY:"center"}}}},t=new fabric.Canvas("tshirtCanvas"),v=document.querySelector("#product-image"),D=document.querySelector("#design-area"),P=(v==null?void 0:v.getAttribute("data-type"))||"default",X=v==null?void 0:v.getAttribute("data-id"),w=`${X}.front_design`,A=`${X}.back_design`,S=Math.random().toString(36).substring(7);let d={},H=[...document.querySelectorAll(".text-style-btn")],a={current_image_url:"",current_image_side:"front"};const h={font_family:document.querySelector("#font_family"),font_size:document.querySelector("#font_size"),text_color:document.querySelector("#text_color"),btns:H,text_container:document.querySelector("#textInputsContainer"),add_text_btn:document.querySelector("#addTextInput")};let m="",f="",p=null,T,C,b=1;const F=.1;function he(){se(),W(),R(),J()}function W(){M(),window.addEventListener("resize",M()),ce(),N()}function J(){document.getElementById("zoom-in").addEventListener("click",()=>{b<2&&(b+=F,e(b))}),document.getElementById("zoom-out").addEventListener("click",()=>{b>.5&&(b-=F,e(b))});function e(i){const o=t.getCenter();t.zoomToPoint(new fabric.Point(o.left,o.top),i),n()}function n(){document.getElementById("zoom-level").textContent=Math.round(b*100)+"%"}window.addEventListener("beforeunload",r);function r(){Object.keys(localStorage).forEach(i=>{(i.includes("/colors/")||i===w||i===A||i===a.current_image_side||i===S+".front_design"||i===S+".back_design"||i===S+".front_image"||i===S+".back_image")&&localStorage.removeItem(i)})}ee(),me(),V(),Z(),K(),t.on("object:modified",function(i){g(),_(a.current_image_url)}),t.on("selection:created",function(i){const u={...O(t)[P].box};t.getObjects().forEach(l=>{l&&l.type=="rect"&&(l.set({...u,stroke:"#ccc",strokeWidth:2}),t.renderAll())})}),t.on("selection:cleared",function(){t.getObjects().forEach(i=>{i&&i.type=="rect"&&i.set({strokeWidth:0,stroke:""})})})}function N(){const n={...O(t)[P].box};let r=new fabric.Rect({...n,strokeWidth:0,hasControls:!1,lockMovementX:!0,lockMovementY:!0,lockScalingX:!0,lockScalingY:!0,lockRotation:!0});t.add(r);let i=new fabric.Rect({left:n.left,top:n.top,width:n.width,height:n.height,originX:"center",originY:"center",absolutePositioned:!0,stay:n.stay,stay_when_pos:!0,hasControls:!1,lockMovementX:!0,lockMovementY:!0,lockScalingX:!0,lockScalingY:!0,lockRotation:!0});T=new fabric.Group([],{left:0,top:0,clipPath:i,selectable:!1,evented:!0,subTargetCheck:!0,interactive:!0,stay:n.stay,stay_when_pos:!0,hasControls:!1,lockMovementX:!0,lockMovementY:!0,lockScalingX:!0,lockScalingY:!0,lockRotation:!0}),t.add(T),t.designGroup=T,C=t.add.bind(t),t.add=function(...o){return o.forEach(u=>{u!==r&&!u.excludeFromClipping&&(u.clipPath=i),C(u)}),t.renderAll(),g(),_(a.current_image_url),t}}function R(){$(d),le(h.font_family),oe(h.text_color),ie(h.font_size),ne(h.btns),G()}function G(){if(!h.add_text_btn||!h.text_container){console.error("Add text button or text container not found");return}h.add_text_btn.addEventListener("click",function(){const e="text_"+Date.now(),n=`
            <div class="text-input-group d-flex align-items-center gap-2" data-input-id="${e}">
                <div class="input-wrapper flex-grow-1">
                    <input type="text" id="${e}" class="form-control input-styled my-4 dynamic-text-input" placeholder="შეიყვანე ტექსტი">
                </div>
                <button type="button" class="btn btn-sm btn-danger remove-text-btn">✕</button>
            </div>

        `;h.text_container.insertAdjacentHTML("beforeend",n);const r=document.getElementById(e);r&&(z([r]),r.closest(".text-input-group").querySelector(".remove-text-btn").addEventListener("click",function(){d[e]&&(t.remove(d[e]),delete d[e],t.renderAll(),g(),_(a.current_image_url)),r.closest(".text-input-group").remove()}))})}function U(){Object.keys(d).forEach(e=>{const n=document.getElementById(e);n&&(n.value=d[e].text)})}function Z(){t.on("mouse:down",function(e){e.target&&(e.target.clipPath&&(t.setActiveObject(e.target),e.target.type==="textbox"&&(p=e.target)),g(),_(a.current_image_url))})}function K(){t.on("resize",function(){const e={left:t.width/2,top:t.height/2,width:t.width*.4,height:t.height*.2};clipPath.set(e),boundingBox.set(e),t.getObjects().forEach(n=>{n!==boundingBox&&!n.excludeFromClipping&&(n.clipPath=clipPath)}),t.renderAll(),g(),_(a.current_image_url)})}function V(){document.querySelectorAll(".color-option").forEach(i=>{i.addEventListener("click",function(o){m=this.getAttribute("data-front-image"),f=this.getAttribute("data-back-image"),m.includes("color")||(m=null),f.includes("color")||(f=null),Y(),m&&x(m,"color",f)})});let n=document.querySelector("#showFront");n&&n.addEventListener("click",function(i){i.preventDefault(),console.log("clicked front"),m&&x(m,"pos")});let r=document.querySelector("#showBack");r&&r.addEventListener("click",function(i){i.preventDefault(),console.log("selectedBackImage: ",f),console.log("clicked back"),f&&x(f,"pos")})}function Y(){document.querySelectorAll("#customizationForm input, #customizationForm select, #customizationForm button").forEach(n=>{n.disabled=!1})}function Q(e){e.set({stroke:"",strokeWidth:0})}function x(e,n="color",r="",i=!1){if(e&&a.current_image_url!=e){if(a.current_image_url=e,console.log("imageURL: ",e),console.log("backImageURL: ",r),n==="pos"){a.current_image_side=="front"?a.current_image_side="back":a.current_image_side="front",console.log("changing side to:  ",a.current_image_side);let o=a.current_image_side=="front"?w:A,u=localStorage.getItem(o);if(!u)t.getObjects().forEach(l=>{l.stay_when_pos||l.type==="rect"||l.type==="group"||t.remove(l),l.type=="rect"&&Q(l)}),fabric.Image.fromURL(e,function(l){let c=Math.min(t.width/l.width,t.height/l.height);l.set({product_image:!0,left:t.width/2,top:t.height/2,originX:"center",originY:"center",scaleX:c,scaleY:c,selectable:!1,hasControls:!1,excludeFromClipping:!0}),t.add(l),t.sendToBack(l),t.renderAll(),localStorage.setItem(e,JSON.stringify(t))});else{t.clear(),h.text_container&&Array.from(h.text_container.children).forEach(c=>{c.id!=="addTextInput"&&c.remove()});let l=0;t.loadFromJSON(u,function(){t.renderAll(),d={},h.text_container&&(h.text_container.innerHTML=""),t.getObjects().forEach(s=>{if(s.type=="rect",s._originalElement&&s._originalElement.src.includes("color"),s.type=="image"&&s._originalElement&&s._originalElement.src.includes("clipart"),s.type==="textbox"){s.input_id||(l++,s.input_id="text_"+l),d[s.input_id]=s;let y=document.getElementById(s.input_id);console.log("existingInput: ",y),y?y.value=s.text:ae(s.input_id,s.text)}});const c=document.querySelectorAll(".dynamic-text-input");console.log("dynamicInputs: ",c),c.length>0&&z(Array.from(c)),$(d),U()}),fabric.Image.fromURL(e,function(c){let s=Math.min(t.width/c.width,t.height/c.height);c.set({product_image:!0,left:t.width/2,top:t.height/2,originX:"center",originY:"center",scaleX:s,scaleY:s,selectable:!1,hasControls:!1,excludeFromClipping:!0}),t.add(c),t.sendToBack(c),t.renderAll()})}return}if(n=="color"){if(i){let o=a.current_image_side=="front"?w:A,u=localStorage.getItem(o);u&&t.loadFromJSON(u),fabric.Image.fromURL(e,function(l){let c=Math.min(t.width/l.width,t.height/l.height);l.set({product_image:!0,left:t.width/2,top:t.height/2,originX:"center",originY:"center",scaleX:c,scaleY:c,selectable:!1,hasControls:!1,excludeFromClipping:!0}),t.add(l),t.sendToBack(l),t.renderAll()});return}j(e,r);return}}}function j(e,n){te();let r=a.current_image_side=="front"?e:n;a.current_image_url=r,fabric.Image.fromURL(r,function(i){let o=Math.min(t.width/i.width,t.height/i.height);i.set({product_image:!0,left:t.width/2,top:t.height/2,originX:"center",originY:"center",scaleX:o,scaleY:o,selectable:!1,hasControls:!1,excludeFromClipping:!0}),t.add(i),t.sendToBack(i),t.renderAll()})}function ee(){document.addEventListener("keydown",function(e){if(e.key==="Delete"){let n=t.getActiveObject();if(n&&n.type==="textbox"){const r=document.getElementById(n.input_id),i=r.closest(".text-input-group").querySelector(".remove-text-btn");i&&r&&r.id==n.input_id&&(r.remove(),i.remove()),t.remove(n),t.renderAll(),g(),_(a.current_image_url)}else n&&(t.remove(n),t.renderAll(),g())}})}function te(){t.getObjects().forEach(e=>{e.product_image&&t.remove(e)})}function ne(e){e.forEach(n=>{n.addEventListener("click",()=>{if(!p){alert("Please select a text object first");return}const r=n.getAttribute("data-style"),i={bold:()=>I("fontWeight","bold","normal"),italic:()=>I("fontStyle","italic","normal"),underline:()=>I("underline",!0,!1),shadow:()=>I("shadow","2px 2px 5px rgba(0,0,0,0.3)",""),curved:()=>re(p),normal:()=>p.set({fontWeight:"normal",fontStyle:"normal",underline:!1,shadow:"",path:null})};i[r]&&i[r](),t.renderAll()})})}function I(e,n,r){p.set(e,p[e]===n?r:n)}function re(e){if(!e||e.type!=="textbox"){alert("Please select a text object.");return}let n=e.text||" ",r=80,i=Math.max(5,150/n.length);e.set("path",null);let o=new fabric.Path(`M 0,${r} A ${r},${r/1.5} 0 1,1 ${r*2},${r}`,{fill:"",stroke:"",selectable:!1,evented:!1});e.set({path:o,pathSide:"top",pathAlign:"center",charSpacing:i*10,originX:"center",left:t.width/2}),t.renderAll(),g(),_(a.current_image_url)}function ie(e){e.addEventListener("input",n=>{p&&(p.set("fontSize",parseInt(e.value)),t.renderAll(),g(),_(a.current_image_url))})}function oe(e){e.addEventListener("click",n=>{e.showPicker()}),e.addEventListener("change",n=>{p&&(p.set("fill",e.value),t.renderAll(),g(),_(a.current_image_url))})}function le(e){e.addEventListener("change",n=>{p&&(p.set("fontFamily",e.value),t.renderAll(),g(),_(a.current_image_url))})}function z(e){console.log("inputs in handleTextInputs: ",e);let n=O(t);for(let r of e)r&&r.addEventListener("input",i=>{if(d[r.id])d[r.id].set({text:r.value}),t.setActiveObject(d[r.id]),p=d[r.id],t.renderAll(),g();else{const o=Object.keys(d).length,u=t.height*.2,l=t.height/2-u/2,c=o%5,s=l+u*(c+1)/6,y=n.text;d[r.id]=new fabric.Textbox("",{left:t.width/2,input_id:r.id,top:s,originX:"center",originY:"center",textAlign:"center",selectable:!0,evented:!0,...y}),t.add(d[r.id]),d[r.id].set({text:r.value}),t.setActiveObject(d[r.id]),p=d[r.id],t.renderAll(),g()}})}function $(e){console.log("objects in handleInlineTextInputs: ",e),t.on("text:changed",n=>{let r=n.target;if(r.input_id){const i=document.getElementById(r.input_id);console.log("input: ",i),i&&(i.value=r.text)}_(a.current_image_url),g()})}function ae(e,n){if(!h.text_container)return;const r=`
        <div class="text-input-group d-flex align-items-center gap-2" data-input-id="${e}">
            <div class="input-wrapper flex-grow-1">
                <input type="text" id="${e}" class="form-control input-styled my-4 dynamic-text-input" placeholder="შეიყვანე ტექსტი" value="${n||""}">
            </div>
            <button type="button" class="btn btn-sm btn-danger remove-text-btn">✕</button>
        </div>
    `;h.text_container.insertAdjacentHTML("beforeend",r);const i=document.getElementById(e);i&&i.closest(".text-input-group").querySelector(".remove-text-btn").addEventListener("click",function(){d[e]&&(t.remove(d[e]),delete d[e],t.renderAll(),g(),_(a.current_image_url)),i.closest(".text-input-group").remove()})}function ce(){let n=document.querySelectorAll(".color-option")[0],r=n.getAttribute("data-front-image"),i=w;localStorage.getItem(i)?(x(r,"color","",!0),m=r,m.includes("color")||(m=null),f=n.getAttribute("data-back-image"),f.includes("color")||(f=null)):(m=r,m.includes("color")||(m=null),f=n.getAttribute("data-back-image"),f.includes("color")||(f=null),a.front_image_url=r,a.back_image_url=f,x(r,"color",f)),Y()}function se(){de(),ue()}function de(){document.querySelectorAll(".clipart-img").forEach(n=>{n.addEventListener("click",fe)}),document.querySelector("#clipartCategory").addEventListener("change",ge)}function ue(){const e=document.querySelector("#uploadSidebar"),n=document.querySelector("#toggleUploadSidebar"),r=document.querySelector("#closeUploadSidebar");let i=document.querySelector("#uploaded_image");n.addEventListener("click",o=>B(o,e)),r.addEventListener("click",o=>{B(o,e,0)}),i.addEventListener("change",function(o){let u=new FileReader;u.onload=function(){let l=document.createElement("img");l.src=u.result,document.querySelector("#imagePreviewContainer").innerHTML="",document.querySelector("#imagePreviewContainer").appendChild(l)},u.readAsDataURL(o.target.files[0])}),document.querySelector("#imagePreviewContainer")&&document.querySelector("#imagePreviewContainer").addEventListener("click",function(o){let l=o.target.src;l&&fabric.Image.fromURL(l,function(c){let s=t.width*.4,y=t.height*.4,E=Math.min(s/c.width,y/c.height);c.set({left:t.width/2-c.width*E/2,top:t.height/2-c.height*E/2,scaleX:E,scaleY:E,selectable:!0}),t.add(c),t.setActiveObject(c),g(),_(a.current_image_url)})})}function fe(){let e=this.getAttribute("data-image");fabric.Image.fromURL(e,function(n){let r=t.width*.4,i=t.height*.4,o=Math.min(r/n.width,i/n.height);n.set({left:t.width/2-n.width*o/2,top:t.height/2-n.height*o/2,scaleX:o,scaleY:o,selectable:!0,hasControls:!0,stay:!0}),t.add(n),t.setActiveObject(n),t.renderAll(),_(a.current_image_url)})}function ge(e){let n=e.target.value;document.querySelectorAll(".clipart-img").forEach(i=>{n==="all"||i.dataset.category===n?i.style.display="block":i.style.display="none"})}function M(e){t.setWidth(D.clientWidth),t.setHeight(D.clientWidth*1.5)}function g(){let e=a.current_image_side=="front"?w:A,n=t.toJSON();n.objects=n.objects.filter(r=>!r.src||!r.src.includes("color")),localStorage.setItem(e,JSON.stringify(n))}function _(e){localStorage.setItem(e,JSON.stringify(t))}let k={front_image:"",back_image:""};function me(){document.querySelector("#addToCart").addEventListener("click",function(e){e.preventDefault();const n=a.current_image_side;L(n),f?n==="front"&&f?(x(f,"pos"),setTimeout(()=>{L("back"),q()},500)):n==="back"&&m&&(x(m,"pos"),setTimeout(()=>{L("front"),q()},500)):q()})}function L(e){try{t.setZoom(1),t.setViewportTransform([1,0,0,1,0,0]),t.renderAll(),localStorage.setItem(`${S}.${e}_design`,JSON.stringify(t));const n=e==="front"?w:A;localStorage.setItem(n,JSON.stringify(t.toJSON()));const r=[];t.getObjects().forEach(o=>{(o.type==="rect"||o.type==="group")&&(r.push(o),t.remove(o))});const i=t.toDataURL({format:"png",quality:1});r.forEach(o=>{o.set({selectable:!1,hasControls:!1,evented:!1,stay:!0,stay_when_pos:!0}),C(o),t.renderAll()}),e==="front"?k.front_image=i:k.back_image=i}catch{alert("Unable to save design. Storage limit reached. Try clearing browser data or removing old designs.")}}function q(){if(!k.front_image){alert("Please save your design first");return}const e=k.back_image||null;let n={front_image:k.front_image,back_image:e,product_id:v.getAttribute("data-id"),v_hash:localStorage.getItem("v_hash"),quantity:localStorage.getItem("quantity")||1,price:null,default_img:0},r=new FormData;r.append("front_image",n.front_image),r.append("product_id",n.product_id),r.append("v_hash",n.v_hash),r.append("quantity",n.quantity),r.append("default_img",n.default_img),e&&r.append("back_image",e),axios.post("/cart",r).then(i=>{alert("Item successfully added to cart")}).catch(i=>{console.error("Error adding to cart:",i),alert("There was an error adding the item to cart")})}export{he as default};
